name: Run Tournament

on:
  workflow_dispatch:
    inputs:
      tournament:
        description: "Tournament slug or ID (e.g. metaculus-cup-spring-2026, spring-aib-2026)"
        required: false
        default: "metaculus-cup-spring-2026"
        type: string
      force_repost:
        description: "Force re-post on previously forecasted questions"
        required: false
        default: "false"
        type: choice
        options: ["false", "true"]
  # DISABLED: GitHub cron is unreliable at midnight UTC
  # Using cron-job.org external trigger instead
  # schedule:
  #   - cron: "*/15 * * * *"

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      METACULUS_TOKEN: ${{ secrets.METACULUS_TOKEN }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      EXA_API_KEY: ${{ secrets.EXA_API_KEY }}
      SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
      TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
      BRAVE_API_KEY: ${{ secrets.BRAVE_API_KEY }}
      PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Cache Poetry and venv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pypoetry
            .venv
          key: poetry-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: |
          poetry config virtualenvs.in-project true
          poetry install --no-interaction --no-ansi

      - name: Run bot (tournament)
        shell: bash
        run: |
          set -o pipefail
          EXTRA_FLAGS=""
          if [[ "${{ github.event.inputs.force_repost }}" == "true" ]]; then
            EXTRA_FLAGS="--force-repost"
          fi
          TOURNAMENT_INPUT="${{ github.event.inputs.tournament }}"
          if [[ -z "$TOURNAMENT_INPUT" ]]; then
            TOURNAMENT_INPUT="metaculus-cup-spring-2026"
          fi
          poetry run python bot/main_forecast_pipeline.py --mode tournament --tournament "$TOURNAMENT_INPUT" ${EXTRA_FLAGS} 2>&1 | tee bot.log

      - name: Summarize results
        if: always()
        shell: bash
        run: |
          # Extract last fetched count if present
          retrieved=$(grep -Eo "Fetched [0-9]+ questions \\(Open \\+ Upcoming\\)" bot.log | awk '{print $2}' | tail -n1 || true)
          retrieved=${retrieved:-0}

          # Extract supported open binary count from the bot log (if present)
          supported_open=$(grep -Eo "Found [0-9]+ OPEN questions \\([0-9]+ supported binary\\)" bot.log | tail -n1 | sed -E 's/.*\\(([0-9]+) supported binary\\).*/\\1/' || true)
          supported_open=${supported_open:-0}

          # Count submission attempts
          posted=$(grep -E "Submission Attempt: posting forecast" -c bot.log || true)

          {
            echo "## Tournament Bot Results"
            echo ""
            echo "**Retrieved questions:** ${retrieved}"
            echo "**Supported open binary questions:** ${supported_open}"
            echo "**Predictions posted:** ${posted}"
            echo ""
            echo "**Question URLs:**"
            grep -Eo "https://www\.metaculus\.com/questions/[0-9]+/" bot.log 2>/dev/null | sort -u || true
          } >> "$GITHUB_STEP_SUMMARY"

          # If we had supported open questions but didn't even attempt a submission, fail the run.
          # This prevents silent green runs that make zero predictions.
          if [[ "${supported_open}" -gt 0 && "${posted}" -eq 0 ]]; then
            echo "::error::Supported open binary questions found (${supported_open}) but zero submission attempts were logged."
            exit 1
          fi

      - name: Upload log artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bot-log
          path: |
            bot.log
            forecastingoutput/
