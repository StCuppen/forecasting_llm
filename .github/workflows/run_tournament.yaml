name: Run Tournament

on:
  workflow_dispatch:
    inputs:
      tournament:
        description: "Tournament slug or ID (e.g. metaculus-cup-spring-2026, spring-aib-2026)"
        required: false
        default: "metaculus-cup-spring-2026"
        type: string
      force_repost:
        description: "Force re-post on previously forecasted questions"
        required: false
        default: "false"
        type: choice
        options: ["false", "true"]
      tournament_id:
        description: "Tournament ID or slug (e.g. metaculus-cup-spring-2026)"
        required: false
        default: "metaculus-cup-spring-2026"
        type: string
      question_types:
        description: "Question types to process: all supported types, or binary only"
        required: false
        default: "all"
        type: choice
        options: ["all", "binary"]
      min_questions:
        description: "Fail run if fewer questions are retrieved"
        required: false
        default: "1"
        type: string
      min_post_attempts:
        description: "Fail run if fewer posting attempts are made"
        required: false
        default: "1"
        type: string
      inter_question_delay_seconds:
        description: "Delay between questions to reduce Metaculus API rate limits"
        required: false
        default: "2.0"
        type: string
      max_open_questions:
        description: "Optional cap for OPEN questions processed (0 = no cap)"
        required: false
        default: "0"
        type: string
  # DISABLED: GitHub cron is unreliable at midnight UTC
  # Using cron-job.org external trigger instead
  # schedule:
  #   - cron: "*/15 * * * *"

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      METACULUS_TOKEN: ${{ secrets.METACULUS_TOKEN }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      EXA_API_KEY: ${{ secrets.EXA_API_KEY }}
      SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
      TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
      BRAVE_API_KEY: ${{ secrets.BRAVE_API_KEY }}
      PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Cache Poetry and venv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pypoetry
            .venv
          key: poetry-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: |
          poetry config virtualenvs.in-project true
          poetry install --no-interaction --no-ansi

      - name: Run bot (tournament)
        shell: bash
        run: |
          set -euo pipefail
          EXTRA_FLAGS=""
          if [[ "${{ github.event.inputs.force_repost }}" == "true" ]]; then
            EXTRA_FLAGS="--force-repost"
          fi

          TOURNAMENT_ID="${{ github.event.inputs.tournament_id }}"
          if [[ -z "${TOURNAMENT_ID}" ]]; then
            TOURNAMENT_ID="${{ github.event.inputs.tournament }}"
          fi
          if [[ -z "${TOURNAMENT_ID}" ]]; then
            TOURNAMENT_ID="metaculus-cup-spring-2026"
          fi
          QUESTION_TYPES="${{ github.event.inputs.question_types || 'all' }}"
          MIN_QUESTIONS="${{ github.event.inputs.min_questions || '1' }}"
          MIN_POST_ATTEMPTS="${{ github.event.inputs.min_post_attempts || '1' }}"
          INTER_QUESTION_DELAY_SECONDS="${{ github.event.inputs.inter_question_delay_seconds || '2.0' }}"
          MAX_OPEN_QUESTIONS="${{ github.event.inputs.max_open_questions || '0' }}"

          poetry run python bot/main_forecast_pipeline.py \
            --mode tournament \
            --tournament-id "${TOURNAMENT_ID}" \
            --question-types "${QUESTION_TYPES}" \
            --min-questions "${MIN_QUESTIONS}" \
            --min-post-attempts "${MIN_POST_ATTEMPTS}" \
            --inter-question-delay-seconds "${INTER_QUESTION_DELAY_SECONDS}" \
            --max-open-questions "${MAX_OPEN_QUESTIONS}" \
            ${EXTRA_FLAGS} 2>&1 | tee bot.log

      - name: Summarize results
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          # Extract last fetched count if present
          retrieved=$(grep -E "Fetched [0-9]+ questions \\(Open \\+ Upcoming\\)" bot.log | sed -nE 's/.*Fetched ([0-9]+) questions.*/\1/p' | tail -n1 || true)
          if [[ -z "${retrieved}" ]]; then
            retrieved=$(grep -E "Retrieved [0-9]+ questions from tournament" bot.log | sed -nE 's/.*Retrieved ([0-9]+) questions.*/\1/p' | tail -n1 || true)
          fi
          retrieved=${retrieved:-0}

          # Extract supported open count from the bot log (if present)
          supported_open=$(grep -E "Found [0-9]+ OPEN questions \\([0-9]+ supported" bot.log | sed -nE 's/.*\(([0-9]+) supported.*/\1/p' | tail -n1 || true)
          supported_open=${supported_open:-0}
          if ! [[ "${supported_open}" =~ ^[0-9]+$ ]]; then
            supported_open=0
          fi

          # Count submission attempts
          posted=$(grep -E "Submission Attempt: posting forecast" -c bot.log || true)
          if ! [[ "${posted}" =~ ^[0-9]+$ ]]; then
            posted=0
          fi
          skipped_prev=$(grep -E "Skipping [0-9]+ previously forecasted questions" bot.log | sed -nE 's/.*Skipping ([0-9]+) previously forecasted questions.*/\1/p' | tail -n1 || true)
          skipped_prev=${skipped_prev:-0}
          if ! [[ "${skipped_prev}" =~ ^[0-9]+$ ]]; then
            skipped_prev=0
          fi
          skipped_prev_runstats=$(grep -E "Run Stats:.*skipped_already_forecasted=[0-9]+" bot.log | sed -nE 's/.*skipped_already_forecasted=([0-9]+).*/\1/p' | tail -n1 || true)
          skipped_prev_runstats=${skipped_prev_runstats:-0}
          if ! [[ "${skipped_prev_runstats}" =~ ^[0-9]+$ ]]; then
            skipped_prev_runstats=0
          fi
          failures=$(grep -E "Forecast report failure:" -c bot.log || true)

          {
            echo "## Tournament Bot Results"
            echo ""
            echo "**Retrieved questions:** ${retrieved}"
            echo "**Supported open questions:** ${supported_open}"
            echo "**Predictions posted:** ${posted}"
            echo "**Skipped previously forecasted:** ${skipped_prev_runstats}"
            echo "**Forecast failures:** ${failures}"
            echo ""
            echo "**Question URLs:**"
            grep -Eo "https://www\.metaculus\.com/questions/[0-9]+/" bot.log 2>/dev/null | sort -u || true
          } >> "$GITHUB_STEP_SUMMARY"

          # If we had supported open questions but didn't even attempt a submission, fail the run.
          # This prevents silent green runs that make zero predictions.
          if [[ "${supported_open}" -gt 0 && "${posted}" -eq 0 ]]; then
            if [[ "${skipped_prev}" -ge "${supported_open}" || "${skipped_prev_runstats}" -ge "${supported_open}" ]]; then
              echo "All supported open questions were already forecasted; zero submission attempts is expected."
            else
              echo "::error::Supported open questions found (${supported_open}) but zero submission attempts were logged."
              exit 1
            fi
          fi

      - name: Upload log artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bot-log
          path: |
            bot.log
            forecastingoutput/
