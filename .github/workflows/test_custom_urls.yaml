name: Test Custom URLs

on:
  workflow_dispatch:
    inputs:
      urls:
        description: "Comma-separated Metaculus question URLs"
        required: true
        type: string
      post_to_metaculus:
        description: "Post predictions to Metaculus?"
        required: false
        default: "false"
        type: choice
        options: ["false", "true"]
      force_repost:
        description: "Force re-post on previously forecasted questions"
        required: false
        default: "false"
        type: choice
        options: ["false", "true"]

concurrency:
  group: test-${{ github.run_id }}
  cancel-in-progress: false

jobs:
  forecast:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      METACULUS_TOKEN: ${{ secrets.METACULUS_TOKEN }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      EXA_API_KEY: ${{ secrets.EXA_API_KEY }}
      SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
      TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
      BRAVE_API_KEY: ${{ secrets.BRAVE_API_KEY }}
      PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Cache Poetry and venv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pypoetry
            .venv
          key: poetry-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: |
          poetry config virtualenvs.in-project true
          poetry install --no-interaction --no-ansi

      - name: Run forecast on custom URLs
        shell: bash
        run: |
          set -o pipefail
          
          EXTRA_FLAGS=""
          
          # Handle force repost
          if [[ "${{ github.event.inputs.force_repost }}" == "true" ]]; then
            EXTRA_FLAGS="${EXTRA_FLAGS} --force-repost"
          fi
          
          # Handle dry run vs posting
          if [[ "${{ github.event.inputs.post_to_metaculus }}" == "true" ]]; then
            echo "ðŸš€ POSTING MODE: Predictions WILL be posted to Metaculus"
          else
            echo "ðŸ§ª DRY RUN MODE: Predictions will NOT be posted"
            # Temporarily patch the code to disable posting
            sed -i 's/template_bot.publish_reports_to_metaculus = True/template_bot.publish_reports_to_metaculus = False/g' bot/main_forecast_pipeline.py
          fi
          
          echo "Running forecast on URLs: ${{ github.event.inputs.urls }}"
          poetry run python bot/main_forecast_pipeline.py \
            --mode urls \
            --urls "${{ github.event.inputs.urls }}" \
            ${EXTRA_FLAGS} \
            2>&1 | tee forecast.log

      - name: Summarize results
        if: always()
        shell: bash
        run: |
          {
            echo "## Custom URL Forecast Results"
            echo ""
            echo "**Mode:** ${{ github.event.inputs.post_to_metaculus == 'true' && 'ðŸš€ POSTING' || 'ðŸ§ª DRY RUN' }}"
            echo "**URLs:** ${{ github.event.inputs.urls }}"
            echo "**Force Repost:** ${{ github.event.inputs.force_repost }}"
            echo ""
            echo "### Predictions"
            echo ""
            # Extract final probabilities from log
            grep -E "(FINAL ENSEMBLE PREDICTION|Final Prediction|prediction_value)" forecast.log || echo "No predictions found in log"
            echo ""
            echo "### Question URLs Processed"
            grep -Eo "https://www\.metaculus\.com/questions/[0-9]+/" forecast.log 2>/dev/null | sort -u || echo "None found"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload forecast log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: forecast-log
          path: |
            forecast.log
            forecast_reports.json
            forecasts/

      - name: Upload detailed agent logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-logs
          path: forecasts/
          if-no-files-found: ignore
